from paip.task_types import SampleTask
from paip.pipelines.variant_calling import RealignAroundIndels, CreateRecalibrationTable
from paip.helpers.create_cohort_task import create_cohort_task


class RecalibrateAlignmentScores(SampleTask):
    """
    Expects a BAM file and a recalibration table file generated by GATK
    BaseRecalibrator. Runs a command to produce a new BAM recalibrated
    base scores.
    """
    REQUIRES = [RealignAroundIndels, CreateRecalibrationTable]
    OUTPUT = 'realignment_recalibrated.bam'

    def run(self):
        with self.output().temporary_path() as self.temp_bam:
            program_name = 'gatk PrintReads'
            program_options = {
                'input_bam': self.input()[0].path,
                'recalibration_table': self.input()[1].path,
                'output_bam': self.temp_bam,
            }

            self.run_program(program_name, program_options)

        self.rename_temp_bai()


RecalibrateAlignmentScoresCohort = create_cohort_task(RecalibrateAlignmentScores)

